import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { Form, Button, Alert, InputGroup } from 'react-bootstrap';
import { authAPI } from '../services/api';
import OTPVerification from './OTPVerification';
import ForgotPasswordModal from './ForgotPasswordModal';
import './LoginSignup.css';

const LoginSignup = ({ onLogin }) => {
  // Login state
  const [loginEmail, setLoginEmail] = useState('');
  const [loginPassword, setLoginPassword] = useState('');
  const [showLoginPassword, setShowLoginPassword] = useState(false);
  
  // Signup state
  const [signupName, setSignupName] = useState('');
  const [signupEmail, setSignupEmail] = useState('');
  const [signupPassword, setSignupPassword] = useState('');
  const [signupConfirmPassword, setSignupConfirmPassword] = useState('');
  const [countryCode, setCountryCode] = useState('+91');
  const [mobileNumber, setMobileNumber] = useState('');
  const [showSignupPassword, setShowSignupPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  
  // OTP state
  const [showOTPModal, setShowOTPModal] = useState(false);
  const [pendingVerificationEmail, setPendingVerificationEmail] = useState('');
  
  // UI state
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [activeTab, setActiveTab] = useState('login');
  const [validationErrors, setValidationErrors] = useState({});
  const [showForgotModal, setShowForgotModal] = useState(false);
  
  const navigate = useNavigate();

  // Validation Functions
  const validateEmail = (email) => {
    return email.includes('@') && email.length > 3;
  };

  const validatePassword = (password) => {
    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
    return passwordRegex.test(password);
  };

  const getPasswordStrength = (password) => {
    return {
      length: password.length >= 8,
      uppercase: /[A-Z]/.test(password),
      lowercase: /[a-z]/.test(password),
      number: /\d/.test(password),
      special: /[@$!%*?&]/.test(password)
    };
  };

  const validatePhone = (phone) => {
    return /^\d{10}$/.test(phone);
  };

  const handleLogin = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      const response = await authAPI.login(loginEmail, loginPassword);
      const { token, data, role } = response.data;
      
      localStorage.setItem('token', token);
      localStorage.setItem('user', JSON.stringify(data));
      localStorage.setItem('userEmail', data.email);
      localStorage.setItem('userRole', role);

      if (onLogin) onLogin();
      
      if (role === 'Admin') {
        navigate('/admin/dashboard');
      } else {
        navigate('/dashboard');
      }
    } catch (error) {
      setError(error.response?.data?.detail || 'Login failed. Please check your credentials.');
    } finally {
      setLoading(false);
    }
  };

  const handleSignup = async (e) => {
    e.preventDefault();
    setError('');
    setValidationErrors({});
    
    const errors = {};

    if (!signupName.trim()) errors.name = 'Name is required';
    if (!validateEmail(signupEmail)) errors.email = 'Please enter a valid email address';
    if (!validatePassword(signupPassword)) errors.password = 'Password must be at least 8 characters with uppercase, lowercase, number, and special character';
    if (signupPassword !== signupConfirmPassword) errors.confirmPassword = 'Passwords do not match';
    if (!validatePhone(mobileNumber)) errors.phone = 'Please enter a valid 10-digit mobile number';

    if (Object.keys(errors).length > 0) {
      setValidationErrors(errors);
      setError('Please fix the validation errors');
      return;
    }
    
    setLoading(true);
    
    try {
      const userData = {
        email: signupEmail,
        password: signupPassword,
        confirmPassword: signupConfirmPassword,
        name: signupName,
        countryCode: countryCode,
        mobileNumber: mobileNumber
      };

      await authAPI.signup(userData);
      
      setPendingVerificationEmail(signupEmail);
      setShowOTPModal(true);
      
      setSignupName('');
      setSignupEmail('');
      setSignupPassword('');
      setSignupConfirmPassword('');
      setMobileNumber('');
    } catch (error) {
      setError(error.response?.data?.detail || 'Registration failed. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  const handleVerificationSuccess = () => {
    setActiveTab('login');
    setLoginEmail(pendingVerificationEmail);
    setPendingVerificationEmail('');
    alert('âœ… Email verified successfully! You can now login.');
  };

  const passwordChecks = getPasswordStrength(signupPassword);

  return (
    <>
      <div className="modern-login-container">
        <div className="login-wrapper">
          <div className="login-content-card">
            {/* Left Side - Welcome Panel */}
            <div className={`welcome-panel ${activeTab === 'signup' ? 'panel-signup' : 'panel-login'}`}>
              <div className="welcome-content">
                {activeTab === 'login' ? (
                  <>
                    <h1 className="welcome-title">Welcome Back!</h1>
                    <p className="welcome-subtitle">Provide your personal details to use all features</p>
                    <button 
                      className="switch-btn"
                      onClick={() => {
                        setActiveTab('signup');
                        setError('');
                        setValidationErrors({});
                      }}
                    >
                      SIGN UP
                    </button>
                  </>
                ) : (
                  <>
                    <h1 className="welcome-title">Hello, Friend!</h1>
                    <p className="welcome-subtitle">Enter your personal details and start your journey with us</p>
                    <button 
                      className="switch-btn"
                      onClick={() => {
                        setActiveTab('login');
                        setError('');
                        setValidationErrors({});
                      }}
                    >
                      SIGN IN
                    </button>
                  </>
                )}
              </div>
            </div>

            {/* Right Side - Form Panel */}
            <div className="form-panel">
              {activeTab === 'login' ? (
                // Login Form
                <div className="form-content">
                  <h2 className="form-title">Sign In</h2>
                  
                  <div className="social-login">
                    <button type="button" className="social-btn">
                      <i className="bi bi-google"></i>
                    </button>
                    <button type="button" className="social-btn">
                      <i className="bi bi-facebook"></i>
                    </button>
                    <button type="button" className="social-btn">
                      <i className="bi bi-github"></i>
                    </button>
                    <button type="button" className="social-btn">
                      <i className="bi bi-linkedin"></i>
                    </button>
                  </div>

                  <div className="divider">
                    <span>OR</span>
                  </div>

                  <p className="form-subtitle">Use Your Email To Sign In</p>

                  {error && (
                    <Alert variant="danger" dismissible onClose={() => setError('')} className="modern-alert">
                      <i className="bi bi-exclamation-circle me-2"></i>
                      {error}
                    </Alert>
                  )}

                  <Form onSubmit={handleLogin}>
                    <Form.Group className="mb-3">
                      <Form.Control
                        type="email"
                        placeholder="Email"
                        value={loginEmail}
                        onChange={(e) => setLoginEmail(e.target.value)}
                        required
                        className="modern-input"
                      />
                    </Form.Group>

                    <Form.Group className="mb-3">
                      <InputGroup>
                        <Form.Control
                          type={showLoginPassword ? "text" : "password"}
                          placeholder="Password"
                          value={loginPassword}
                          onChange={(e) => setLoginPassword(e.target.value)}
                          required
                          className="modern-input"
                        />
                        <Button
                          variant="link"
                          onClick={() => setShowLoginPassword(!showLoginPassword)}
                          className="password-toggle"
                        >
                          <i className={`bi bi-eye${showLoginPassword ? '-slash' : ''}`}></i>
                        </Button>
                      </InputGroup>
                    </Form.Group>

                    <div className="d-flex justify-content-end mb-3">
                      <a 
                        href="#" 
                        className="forgot-password-link"
                        onClick={(e) => {
                          e.preventDefault();
                          setShowForgotModal(true);
                        }}
                      >
                        Forgot password?
                      </a>
                    </div>

                    <Button
                      type="submit"
                      className="modern-submit-btn"
                      disabled={loading}
                    >
                      {loading ? (
                        <>
                          <span className="spinner-border spinner-border-sm me-2" />
                          Signing in...
                        </>
                      ) : (
                        'SIGN IN'
                      )}
                    </Button>

                    <div className="text-center mt-3">
                      <Link to="/admin_registration" className="admin-link">
                        <i className="bi bi-shield-lock me-2"></i>
                        Admin Registration
                      </Link>
                    </div>
                  </Form>
                </div>
              ) : (
                // Signup Form
                <div className="form-content">
                  <h2 className="form-title">Create Account</h2>
                  
                  <div className="social-login">
                    <button type="button" className="social-btn">
                      <i className="bi bi-google"></i>
                    </button>
                    <button type="button" className="social-btn">
                      <i className="bi bi-facebook"></i>
                    </button>
                    <button type="button" className="social-btn">
                      <i className="bi bi-github"></i>
                    </button>
                    <button type="button" className="social-btn">
                      <i className="bi bi-linkedin"></i>
                    </button>
                  </div>

                  <div className="divider">
                    <span>OR</span>
                  </div>

                  <p className="form-subtitle">Fill Out The Following Info For Registration</p>

                  {error && (
                    <Alert variant="danger" dismissible onClose={() => setError('')} className="modern-alert">
                      <i className="bi bi-exclamation-circle me-2"></i>
                      {error}
                    </Alert>
                  )}

                  <Form onSubmit={handleSignup}>
                    <Form.Group className="mb-3">
                      <Form.Control
                        type="text"
                        placeholder="Name"
                        value={signupName}
                        onChange={(e) => setSignupName(e.target.value)}
                        required
                        className="modern-input"
                        isInvalid={!!validationErrors.name}
                      />
                      <Form.Control.Feedback type="invalid">
                        {validationErrors.name}
                      </Form.Control.Feedback>
                    </Form.Group>

                    <Form.Group className="mb-3">
                      <Form.Control
                        type="email"
                        placeholder="Email"
                        value={signupEmail}
                        onChange={(e) => setSignupEmail(e.target.value)}
                        required
                        className="modern-input"
                        isInvalid={!!validationErrors.email}
                      />
                      <Form.Control.Feedback type="invalid">
                        {validationErrors.email}
                      </Form.Control.Feedback>
                    </Form.Group>

                    <Form.Group className="mb-3">
                      <InputGroup>
                        <Form.Control
                          type={showSignupPassword ? "text" : "password"}
                          placeholder="Password"
                          value={signupPassword}
                          onChange={(e) => setSignupPassword(e.target.value)}
                          required
                          className="modern-input"
                          isInvalid={!!validationErrors.password}
                        />
                        <Button
                          variant="link"
                          onClick={() => setShowSignupPassword(!showSignupPassword)}
                          className="password-toggle"
                        >
                          <i className={`bi bi-eye${showSignupPassword ? '-slash' : ''}`}></i>
                        </Button>
                        <Form.Control.Feedback type="invalid">
                          {validationErrors.password}
                        </Form.Control.Feedback>
                      </InputGroup>
                      {signupPassword && (
                        <div className="password-strength mt-2">
                          <div className={`strength-item ${passwordChecks.length ? 'met' : ''}`}>
                            <i className={`bi bi-${passwordChecks.length ? 'check-circle-fill' : 'circle'}`}></i>
                            <span>8+ characters</span>
                          </div>
                          <div className={`strength-item ${passwordChecks.uppercase ? 'met' : ''}`}>
                            <i className={`bi bi-${passwordChecks.uppercase ? 'check-circle-fill' : 'circle'}`}></i>
                            <span>Uppercase</span>
                          </div>
                          <div className={`strength-item ${passwordChecks.lowercase ? 'met' : ''}`}>
                            <i className={`bi bi-${passwordChecks.lowercase ? 'check-circle-fill' : 'circle'}`}></i>
                            <span>Lowercase</span>
                          </div>
                          <div className={`strength-item ${passwordChecks.number ? 'met' : ''}`}>
                            <i className={`bi bi-${passwordChecks.number ? 'check-circle-fill' : 'circle'}`}></i>
                            <span>Number</span>
                          </div>
                          <div className={`strength-item ${passwordChecks.special ? 'met' : ''}`}>
                            <i className={`bi bi-${passwordChecks.special ? 'check-circle-fill' : 'circle'}`}></i>
                            <span>Special char</span>
                          </div>
                        </div>
                      )}
                    </Form.Group>

                    <Form.Group className="mb-3">
                      <InputGroup>
                        <Form.Control
                          type={showConfirmPassword ? "text" : "password"}
                          placeholder="Confirm Password"
                          value={signupConfirmPassword}
                          onChange={(e) => setSignupConfirmPassword(e.target.value)}
                          required
                          className="modern-input"
                          isInvalid={!!validationErrors.confirmPassword}
                        />
                        <Button
                          variant="link"
                          onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                          className="password-toggle"
                        >
                          <i className={`bi bi-eye${showConfirmPassword ? '-slash' : ''}`}></i>
                        </Button>
                        <Form.Control.Feedback type="invalid">
                          {validationErrors.confirmPassword}
                        </Form.Control.Feedback>
                      </InputGroup>
                    </Form.Group>

                    <Form.Group className="mb-3">
                      <InputGroup>
                        <Form.Select
                          value={countryCode}
                          onChange={(e) => setCountryCode(e.target.value)}
                          className="modern-input country-code-select"
                        >
                          <option value="+91">+91</option>
                          <option value="+1">+1</option>
                          <option value="+44">+44</option>
                        </Form.Select>
                        <Form.Control
                          type="tel"
                          placeholder="Mobile Number"
                          value={mobileNumber}
                          onChange={(e) => setMobileNumber(e.target.value.replace(/\D/g, ''))}
                          maxLength={10}
                          required
                          className="modern-input"
                          isInvalid={!!validationErrors.phone}
                        />
                        <Form.Control.Feedback type="invalid">
                          {validationErrors.phone}
                        </Form.Control.Feedback>
                      </InputGroup>
                    </Form.Group>

                    <Button
                      type="submit"
                      className="modern-submit-btn"
                      disabled={loading}
                    >
                      {loading ? (
                        <>
                          <span className="spinner-border spinner-border-sm me-2" />
                          Creating Account...
                        </>
                      ) : (
                        'SIGN UP'
                      )}
                    </Button>
                  </Form>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      <OTPVerification
        show={showOTPModal}
        onHide={() => setShowOTPModal(false)}
        email={pendingVerificationEmail}
        onVerificationSuccess={handleVerificationSuccess}
      />

      <ForgotPasswordModal
        show={showForgotModal}
        onHide={() => setShowForgotModal(false)}
      />
    </>
  );
};

export default LoginSignup;